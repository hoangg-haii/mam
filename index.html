<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hệ thống dải phân cách tự động v3.35.40</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #4f46e5; --danger: #e11d48; --success: #10b981; --dark: #0f172a; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        .btn-active:active { transform: scale(0.95); filter: brightness(0.9); }
        .btn-pressed { background-color: var(--dark) !important; color: white !important; box-shadow: inset 0 2px 10px rgba(0,0,0,0.2); }

        .switch { position: relative; display: inline-block; width: 54px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1; transition: .4s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(26px); }

        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-enter { animation: modalIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .segmented-control { display: flex; background-color: #f1f5f9; padding: 4px; border-radius: 14px; }
        .segmented-item {
            flex: 1; padding: 10px; font-size: 11px; font-weight: 800; text-align: center;
            border-radius: 10px; cursor: pointer; transition: all 0.2s; text-transform: uppercase;
        }
        .segmented-item.active { background-color: white; color: var(--primary); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="flex flex-col items-center">

    <!-- INTRO MODAL -->
    <div id="intro-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-slate-900/95 backdrop-blur-md">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl overflow-hidden modal-enter">
            <div class="bg-gradient-to-br from-indigo-600 to-blue-700 p-8 text-center text-white">
                <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-xl rotate-3">
                    <img src="https://storage-vnportal.vnpt.vn/qnm-ubnd/5892/TuanTQC/Tuan20t11/logo.png" alt="Logo" class="w-14 h-14 object-contain">
                </div>
                <h2 class="text-lg font-black uppercase tracking-tight">Dự án dải phân cách</h2>
                <p class="text-[10px] font-bold opacity-80 uppercase tracking-[0.3em] mt-2">Phiên bản v3.35.40</p>
            </div>
            <div class="p-8 space-y-6 max-h-[60vh] overflow-y-auto custom-scroll">
                <div class="space-y-4">
                    <div class="flex flex-col border-l-4 border-indigo-500 pl-4">
                        <span class="text-[9px] text-slate-400 font-black uppercase tracking-widest">Học sinh thực hiện</span>
                        <span class="text-slate-800 font-bold text-sm">Hoàng Hải, Tuyết Nhung, Trường Long</span>
                    </div>
                    <div class="flex flex-col border-l-4 border-amber-500 pl-4">
                        <span class="text-[9px] text-slate-400 font-black uppercase tracking-widest">Giáo viên hướng dẫn</span>
                        <span class="text-slate-800 font-bold text-sm">Thầy: Hồ Viết Tiệp</span>
                    </div>
                    <div class="flex flex-col border-l-4 border-emerald-500 pl-4">
                        <span class="text-[9px] text-slate-400 font-black uppercase tracking-widest">Đơn vị</span>
                        <span class="text-indigo-700 font-black text-xs uppercase">Trường THPT Trần Quý Cáp</span>
                    </div>
                </div>
                <button onclick="closeModal('intro-modal')" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-xs shadow-xl active:scale-95 transition-all uppercase tracking-[0.2em]">Bắt đầu điều khiển</button>
            </div>
        </div>
    </div>

    <!-- GUIDE POPUP MODAL (NEW) -->
    <div id="guide-popup" class="fixed inset-0 z-[120] flex items-center justify-center p-6 bg-slate-900/80 backdrop-blur-sm hidden" onclick="closeModal('guide-popup')">
        <div class="bg-white w-full max-w-xs rounded-[2rem] shadow-2xl overflow-hidden modal-enter p-8 text-center" onclick="event.stopPropagation()">
            <div id="guide-icon" class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            </div>
            <h3 id="guide-title" class="text-sm font-black text-slate-900 uppercase mb-3">Tiêu đề</h3>
            <div id="guide-content" class="text-slate-600 text-[11px] font-medium leading-relaxed mb-6 text-left space-y-2">
                <!-- Nội dung sẽ render tại đây -->
            </div>
            <button onclick="closeModal('guide-popup')" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black text-[10px] uppercase tracking-widest">Đã hiểu</button>
        </div>
    </div>

    <!-- THANK YOU MODAL -->
    <div id="thanks-modal" class="fixed inset-0 z-[110] flex items-center justify-center p-6 bg-slate-900/98 backdrop-blur-xl hidden">
        <div class="bg-white w-full max-w-sm rounded-[3rem] shadow-2xl overflow-hidden modal-enter p-10 text-center">
            <div class="w-24 h-24 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
            </div>
            <h2 class="text-2xl font-black text-slate-900 uppercase leading-none mb-2">Cảm ơn bạn!</h2>
            <p class="text-slate-500 text-sm font-medium leading-relaxed mb-8">Hệ thống đã hạ gầm an toàn và ngắt kết nối thành công. Hẹn gặp lại!</p>
            <button onclick="location.reload()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg">Đóng ứng dụng</button>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div id="overlay" class="fixed inset-0 z-[60] bg-slate-900/50 hidden opacity-0 transition-opacity duration-300" onclick="toggleSidebar()"></div>
    <div id="sidebar" class="fixed top-0 left-0 bottom-0 w-72 bg-white z-[70] shadow-2xl translate-x-[-100%] flex flex-col">
        <div class="p-10 bg-slate-900 text-white flex flex-col items-center justify-center">
            <img src="https://storage-vnportal.vnpt.vn/qnm-ubnd/5892/TuanTQC/Tuan20t11/logo.png" class="w-20 h-20 mb-4">
            <h2 class="text-center text-[10px] font-black uppercase tracking-tighter">Dải phân cách tự động</h2>
        </div>
        <div class="flex-1 p-6 space-y-4 overflow-y-auto custom-scroll flex flex-col">
            <div class="p-5 bg-slate-50 rounded-3xl border border-slate-100 flex items-center justify-between shadow-sm">
                <div class="flex flex-col">
                    <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Bluetooth</span>
                    <div class="flex items-center mt-1">
                        <div id="status-dot" class="w-2 h-2 rounded-full bg-red-500 mr-2"></div>
                        <span id="status-label" class="text-[10px] font-black text-slate-700 uppercase">OFFLINE</span>
                    </div>
                </div>
                <button id="connect-btn" onclick="handleBluetoothConnection()" class="bg-blue-600 text-white px-5 py-2.5 rounded-xl text-[9px] font-black uppercase active:scale-90">Kết nối</button>
            </div>
            
            <nav class="space-y-2 pt-4 border-t flex-1">
                <button onclick="showPage('control')" class="nav-item w-full p-4 rounded-2xl bg-indigo-50 text-indigo-700 font-black text-[11px] uppercase text-left transition-all">Bảng điều khiển</button>
                <button onclick="showPage('alarm')" class="nav-item w-full p-4 rounded-2xl hover:bg-slate-50 text-slate-600 font-bold text-[11px] uppercase text-left transition-all">Lịch trình</button>
                <button onclick="showPage('warning')" class="nav-item w-full p-4 rounded-2xl hover:bg-slate-50 text-slate-600 font-bold text-[11px] uppercase text-left transition-all">Cảnh báo</button>
                <button onclick="showPage('guide')" class="nav-item w-full p-4 rounded-2xl hover:bg-slate-50 text-slate-600 font-bold text-[11px] uppercase text-left transition-all">Hướng dẫn sử dụng</button>
            </nav>

            <div class="pt-6 border-t flex flex-col items-center">
                <button onclick="openIntro()" class="text-slate-400 font-bold text-[10px] uppercase italic mb-4">Thông tin dự án</button>
                <div class="text-[9px] font-black text-slate-300 uppercase tracking-[0.2em] bg-slate-50 px-4 py-2 rounded-full border">Version 3.35.40</div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <header class="w-full flex items-center justify-between p-6 z-50">
        <button onclick="toggleSidebar()" class="p-3.5 bg-white shadow-md rounded-2xl text-slate-800"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
        <h1 id="page-title" class="text-[11px] font-black text-slate-900 uppercase tracking-widest text-center flex-1 mx-4">Bảng điều khiển</h1>
        <div class="w-12 h-12 bg-indigo-100 rounded-2xl flex items-center justify-center"><svg class="text-indigo-600" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
    </header>

    <main class="w-full max-w-md px-6 flex-1 flex flex-col overflow-hidden pb-10">
        <!-- CONTROL PAGE -->
        <div id="page-control" class="space-y-6 flex flex-col h-full overflow-hidden">
            <div class="bg-slate-900 p-8 rounded-[2.5rem] shadow-2xl border-b-[6px] border-slate-950 text-center relative overflow-hidden">
                <div class="rtc-display text-5xl font-['JetBrains_Mono'] font-bold text-emerald-400 leading-none relative z-10">00:00:00</div>
                <div class="date-display text-[9px] font-black text-emerald-600/60 uppercase mt-3 relative z-10 tracking-[0.3em]">CẬP NHẬT THỜI GIAN...</div>
            </div>
            
            <div class="bg-white p-2 rounded-2xl border flex-none">
                <div class="segmented-control">
                    <div id="mode-auto" class="segmented-item active" onclick="setMode('auto')">Tự động</div>
                    <div id="mode-manual" class="segmented-item" onclick="setMode('manual')">Thủ công</div>
                </div>
            </div>

            <div class="flex-1 flex flex-col justify-center gap-6">
                <div id="manual-ui" class="hidden grid grid-cols-3 gap-4">
                    <button data-cmd="1" class="momentary-btn h-20 bg-white border-2 rounded-[1.8rem] font-black text-xl text-slate-800">L1</button>
                    <button data-cmd="t" class="momentary-btn h-20 bg-slate-900 text-white rounded-[1.8rem] flex items-center justify-center shadow-lg"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><path d="m18 15-6-6-6 6"/></svg></button>
                    <button data-cmd="3" class="momentary-btn h-20 bg-white border-2 rounded-[1.8rem] font-black text-xl text-slate-800">R1</button>
                    <button data-cmd="2" class="momentary-btn h-20 bg-white border-2 rounded-[1.8rem] font-black text-xl text-slate-800">L2</button>
                    <button data-cmd="l" class="momentary-btn h-20 bg-slate-900 text-white rounded-[1.8rem] flex items-center justify-center shadow-lg"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><path d="m6 9 6 6 6-6"/></svg></button>
                    <button data-cmd="4" class="momentary-btn h-20 bg-white border-2 rounded-[1.8rem] font-black text-xl text-slate-800">R2</button>
                </div>
                <div id="auto-ui-placeholder" class="text-center py-12 px-6 border-2 border-dashed rounded-[2.5rem] space-y-3">
                    <div class="text-slate-400 font-black text-xs uppercase italic">Chế độ tự động</div>
                    <p class="text-[10px] text-slate-400">Hệ thống đang hoạt động theo lịch trình sẵn có.</p>
                </div>
                <button onclick="send('dkc')" class="w-full bg-rose-600 text-white py-6 rounded-[2.2rem] font-black text-xs uppercase shadow-xl border-b-[6px] border-rose-800 active:border-b-0 active:translate-y-1">Dừng khẩn cấp</button>
            </div>
        </div>

        <!-- ALARM PAGE -->
        <div id="page-alarm" class="hidden h-full flex flex-col space-y-6 overflow-hidden">
            <div class="bg-white p-6 rounded-[2rem] border shadow-sm space-y-6">
                <div class="segmented-control">
                    <div id="in-manual" class="segmented-item active" onclick="setIn('manual')">Nhập tay</div>
                    <div id="in-file" class="segmented-item" onclick="setIn('file')">Nạp file</div>
                </div>
                <div id="alarm-manual-ui" class="space-y-6">
                    <input type="time" id="alarm-time" step="1" class="w-full text-5xl font-['JetBrains_Mono'] font-black bg-slate-50 rounded-3xl py-6 text-center outline-none">
                    <div class="flex gap-3">
                        <button id="dir-L" onclick="setDir('L')" class="flex-1 py-4 rounded-2xl font-black text-[11px] uppercase bg-slate-100">Trái</button>
                        <button id="dir-R" onclick="setDir('R')" class="flex-1 py-4 rounded-2xl font-black text-[11px] uppercase bg-slate-100">Phải</button>
                    </div>
                    <button onclick="addAlarm()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black uppercase text-[11px]">Thiết lập</button>
                </div>
                <div id="alarm-file-ui" class="hidden py-4 text-center">
                    <label class="flex flex-col items-center p-10 bg-slate-50 border-2 border-dashed rounded-[2rem] cursor-pointer">
                        <svg class="text-slate-400 mb-2" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        <span class="text-[10px] font-black uppercase">Tải tệp .txt</span>
                        <input type="file" class="hidden" accept=".txt" onchange="uploadFile(event)">
                    </label>
                </div>
            </div>
            <div id="pending-list" class="flex-1 overflow-y-auto space-y-3 custom-scroll">
                <div class="text-center py-10 opacity-20 italic text-xs font-bold">Chưa có lịch trình</div>
            </div>
        </div>

        <!-- WARNING PAGE -->
        <div id="page-warning" class="hidden h-full flex flex-col space-y-6">
            <div class="bg-rose-50 border-2 border-rose-100 p-8 rounded-[2.5rem] text-center"><div class="text-rose-600 text-3xl font-black uppercase italic tracking-tighter">Emergency</div></div>
            <div class="space-y-4">
                <div class="bg-white p-7 rounded-3xl border flex items-center justify-between">
                    <span class="font-black text-xs uppercase text-slate-700">Đèn cảnh báo</span>
                    <label class="switch"><input type="checkbox" onchange="send(this.checked?'cbon':'cboff')"><span class="slider"></span></label>
                </div>
                <div class="bg-white p-7 rounded-3xl border flex items-center justify-between">
                    <span class="font-black text-xs uppercase text-slate-700">Còi báo động</span>
                    <label class="switch"><input type="checkbox" onchange="send(this.checked?'ccbn':'ccbf')"><span class="slider"></span></label>
                </div>
                <button onclick="emergency()" class="w-full bg-gradient-to-r from-rose-600 to-rose-500 text-white py-7 rounded-[2.2rem] font-black text-xs uppercase shadow-xl active:scale-95">Kích hoạt toàn diện</button>
            </div>
        </div>

        <!-- GUIDE PAGE -->
        <div id="page-guide" class="hidden h-full flex flex-col space-y-4 overflow-y-auto custom-scroll pr-2">
            <div class="bg-indigo-600 p-6 rounded-[2rem] text-white">
                <h3 class="font-black text-lg uppercase mb-1">Hướng dẫn nhanh</h3>
                <p class="text-[10px] opacity-80 uppercase tracking-widest font-bold">Nhấn vào mục để xem chi tiết</p>
            </div>
            
            <div class="space-y-3">
                <!-- MỤC 1 -->
                <div onclick="openGuide('connect')" class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-4 cursor-pointer active:scale-95 transition-all">
                    <div class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center font-black text-xs">01</div>
                    <span class="font-black text-[11px] uppercase text-slate-800">Kết nối thiết bị</span>
                </div>

                <!-- MỤC 2 -->
                <div onclick="openGuide('operation')" class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-4 cursor-pointer active:scale-95 transition-all">
                    <div class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center font-black text-xs">02</div>
                    <span class="font-black text-[11px] uppercase text-slate-800">Chế độ vận hành & Lịch trình</span>
                </div>

                <!-- MỤC 3 -->
                <div onclick="openGuide('alarm')" class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-4 cursor-pointer active:scale-95 transition-all">
                    <div class="w-8 h-8 rounded-full bg-amber-500 text-white flex items-center justify-center font-black text-xs">03</div>
                    <span class="font-black text-[11px] uppercase text-slate-800">Cảnh báo khẩn cấp</span>
                </div>

                <!-- MỤC 4 -->
                <div onclick="openGuide('daynight')" class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-4 cursor-pointer active:scale-95 transition-all">
                    <div class="w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center font-black text-xs">04</div>
                    <span class="font-black text-[11px] uppercase text-slate-800">Chế độ Ngày/Đêm</span>
                </div>

                <!-- MỤC 5 -->
                <div onclick="openGuide('stop')" class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-4 cursor-pointer active:scale-95 transition-all">
                    <div class="w-8 h-8 rounded-full bg-rose-600 text-white flex items-center justify-center font-black text-xs">05</div>
                    <span class="font-black text-[11px] uppercase text-rose-600">Dừng khẩn cấp</span>
                </div>
            </div>
            <div class="p-6 text-center opacity-30 italic text-[10px] font-bold uppercase tracking-widest">Version: v3.35.40</div>
        </div>
    </main>

    <script>
        // -- CORE CONFIG & STATE --
        const UUID_SER = "0000ffe0-0000-1000-8000-00805f9b34fb";
        const UUID_CHA = "0000ffe1-0000-1000-8000-00805f9b34fb";
        let device, char, isBusy = false, night = false, dir = 'L';

        // -- BLUETOOTH CORE --
        async function handleBluetoothConnection() {
            if (device?.gatt.connected) {
                try {
                    updateSt("Đang xử lý...");
                    await send('h'); 
                    await sleep(500);
                    await send('baibai');
                    await sleep(500);
                    document.getElementById('thanks-modal').classList.remove('hidden');
                    await device.gatt.disconnect();
                } catch (e) { location.reload(); }
            } else {
                try {
                    updateSt("Tìm kiếm...");
                    device = await navigator.bluetooth.requestDevice({ filters: [{ name: 'ESP32_Motor_Control' }], optionalServices: [UUID_SER] });
                    const srv = await (await device.gatt.connect()).getPrimaryService(UUID_SER);
                    char = await srv.getCharacteristic(UUID_CHA);
                    
                    document.getElementById('status-dot').className = "w-2 h-2 rounded-full bg-emerald-500 shadow-lg";
                    document.getElementById('status-label').innerText = "ONLINE";
                    document.getElementById('connect-btn').innerText = "NGẮT";
                    document.getElementById('connect-btn').className = "bg-rose-600 text-white px-5 py-2.5 rounded-xl text-[9px] font-black uppercase";
                    send('on');
                } catch (e) { updateSt("Lỗi"); }
            }
        }

        async function send(c) {
            if (!char || isBusy) return;
            isBusy = true;
            try { await char.writeValue(new TextEncoder().encode(c + "\n")); } catch(e){}
            setTimeout(() => isBusy = false, 50);
        }

        // -- UI LOGIC --
        function toggleSidebar() {
            const s = document.getElementById('sidebar'), o = document.getElementById('overlay');
            const open = s.style.transform === 'translateX(0%)';
            s.style.transform = open ? 'translateX(-100%)' : 'translateX(0%)';
            o.classList.toggle('hidden', open);
            setTimeout(() => o.style.opacity = open ? '0' : '1', 10);
        }

        function showPage(p) {
            ['control', 'alarm', 'warning', 'guide'].forEach(id => {
                const el = document.getElementById('page-'+id);
                if(el) el.classList.toggle('hidden', id !== p);
            });

            const t = { control: 'Bảng điều khiển', alarm: 'Lịch trình', warning: 'Cảnh báo khẩn cấp', guide: 'Hướng dẫn sử dụng' };
            document.getElementById('page-title').innerText = t[p].toUpperCase();
            
            document.querySelectorAll('.nav-item').forEach(btn => {
                const isActive = btn.innerText.toLowerCase().includes(t[p].toLowerCase());
                btn.className = isActive ? 
                    "nav-item w-full p-4 rounded-2xl bg-indigo-50 text-indigo-700 font-black text-[11px] uppercase text-left transition-all" : 
                    "nav-item w-full p-4 rounded-2xl hover:bg-slate-50 text-slate-600 font-bold text-[11px] uppercase text-left transition-all";
            });

            if (window.innerWidth < 768) toggleSidebar();
        }

        // -- GUIDE POPUP LOGIC (NEW) --
        function openGuide(type) {
            const popup = document.getElementById('guide-popup');
            const title = document.getElementById('guide-title');
            const content = document.getElementById('guide-content');
            
            const guides = {
                'connect': {
                    t: 'Kết nối thiết bị',
                    c: `
                        <p>1. Mở menu và nhấn nút <b>Kết nối</b> màu xanh.</p>
                        <p>2. Chọn thiết bị tên <b>ESP32_Motor_Control</b> trong danh sách hiện ra.</p>
                        <p>3. Khi đèn tín hiệu chuyển sang <b>Xanh (ONLINE)</b>, bạn đã có thể bắt đầu điều khiển.</p>
                    `
                },
                'operation': {
                    t: 'Vận hành & Lịch trình',
                    c: `
                        <p><b>• Tự động:</b> Hệ thống chạy theo các khung giờ đã cài đặt trong tab <i>Lịch trình</i>.</p>
                        <p><b>• Thủ công:</b> Dùng các nút mũi tên (Tới/Lùi) và L1, R1, L2, R2 để di chuyển từng motor riêng lẻ.</p>
                        <p><b>• Ý nghĩa nút:</b> Mũi tên lên (Tới), Mũi tên xuống (Lùi). Các nút L/R dùng để căn chỉnh vị trí dải phân cách.</p>
                    `
                },
                'alarm': {
                    t: 'Cảnh báo khẩn cấp',
                    c: `
                        <p>Dùng trong trường hợp có xe ưu tiên (Cứu thương, Cứu hỏa) hoặc sự cố giao thông:</p>
                        <p><b>• Đèn:</b> Bật dải đèn LED báo hiệu dọc dải phân cách.</p>
                        <p><b>• Còi:</b> Phát âm thanh cảnh báo cường độ cao.</p>
                        <p><b>• Toàn diện:</b> Kích hoạt cả hai cùng lúc.</p>
                    `
                },
                'daynight': {
                    t: 'Chế độ Ngày/Đêm',
                    c: `
                        <p>Tự động tối ưu hóa hoạt động của hệ thống theo thời gian thực:</p>
                        <p><b>• Ban ngày:</b> Ưu tiên tốc độ xử lý nhanh để giải tỏa ùn tắc.</p>
                        <p><b>• Ban đêm:</b> Giảm độ sáng đèn LED, motor hoạt động êm ái hơn để tránh gây tiếng ồn khu dân cư.</p>
                    `
                },
                'stop': {
                    t: 'Dừng khẩn cấp',
                    c: `
                        <p>Đây là nút quan trọng nhất (màu đỏ rực ở trang chủ).</p>
                        <p><b>• Tác dụng:</b> Ngắt ngay lập tức nguồn điện cấp cho các motor.</p>
                        <p><b>• Sử dụng khi:</b> Phát hiện chướng ngại vật bị kẹt hoặc có người/phương tiện đi vào vùng đang chuyển đổi dải phân cách.</p>
                    `
                }
            };

            const data = guides[type];
            title.innerText = data.t;
            content.innerHTML = data.c;
            popup.classList.remove('hidden');
        }

        function setMode(m) {
            document.getElementById('mode-auto').classList.toggle('active', m === 'auto');
            document.getElementById('mode-manual').classList.toggle('active', m === 'manual');
            document.getElementById('manual-ui').classList.toggle('hidden', m !== 'manual');
            document.getElementById('auto-ui-placeholder').classList.toggle('hidden', m !== 'auto');
            send(m === 'manual' ? 'n' : 'h');
        }

        // -- ALARM LOGIC --
        function setIn(m) {
            document.getElementById('in-manual').classList.toggle('active', m === 'manual');
            document.getElementById('in-file').classList.toggle('active', m === 'file');
            document.getElementById('alarm-manual-ui').classList.toggle('hidden', m !== 'manual');
            document.getElementById('alarm-file-ui').classList.toggle('hidden', m !== 'file');
        }

        function setDir(d) {
            dir = d;
            ['L', 'R'].forEach(id => document.getElementById('dir-'+id).className = `flex-1 py-4 rounded-2xl font-black text-[11px] uppercase ${dir === id ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-400'}`);
        }

        function addAlarm() {
            const time = document.getElementById('alarm-time').value;
            if (!time) return;
            const clean = time.replace(/:/g, '') + dir;
            send(clean);
            hist(time, dir);
        }

        function hist(t, d) {
            const l = document.getElementById('pending-list');
            if (l.querySelector('.italic')) l.innerHTML = '';
            const item = document.createElement('div');
            item.className = "flex justify-between items-center p-5 bg-white rounded-3xl border shadow-sm";
            item.innerHTML = `<div><div class="font-black text-xs">${t}</div><div class="text-[8px] font-bold text-slate-400">HƯỚNG: ${d==='L'?'TRÁI':'PHẢI'}</div></div><div class="px-2 py-1 bg-emerald-50 text-emerald-600 text-[8px] font-black rounded">OK</div>`;
            l.prepend(item);
        }

        function uploadFile(e) {
            const f = e.target.files[0]; if (!f) return;
            const r = new FileReader();
            r.onload = async (ev) => {
                for (let l of ev.target.result.split('\n')) {
                    const c = l.trim().toUpperCase();
                    if (c.length === 7) { 
                        await send(c); 
                        hist(`${c.substring(0,2)}:${c.substring(2,4)}:${c.substring(4,6)}`, c.charAt(6));
                        await sleep(300);
                    }
                }
            };
            r.readAsText(f);
        }

        // -- HELPERS --
        function updateSt(t) { document.getElementById('status-label').innerText = t.toUpperCase(); }
        function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function openIntro() { document.getElementById('intro-modal').classList.remove('hidden'); if (window.innerWidth < 768) toggleSidebar(); }
        function emergency() { send('cbon'); setTimeout(() => send('ccbn'), 100); }

        // -- MOMENTARY BUTTONS --
        document.querySelectorAll('.momentary-btn').forEach(b => {
            const c = b.dataset.cmd;
            const start = (e) => { e.preventDefault(); b.classList.add('btn-pressed'); send(c); };
            const stop = () => { b.classList.remove('btn-pressed'); send('d'); };
            b.onmousedown = b.ontouchstart = start;
            b.onmouseup = b.ontouchend = stop;
        });

        // -- TIME LOOP --
        setInterval(() => {
            const d = new Date();
            document.querySelectorAll('.rtc-display').forEach(el => el.innerText = d.toLocaleTimeString('en-GB'));
            document.querySelectorAll('.date-display').forEach(el => el.innerText = d.toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }).toUpperCase());
        }, 1000);

        window.onload = () => {
            const n = new Date();
            document.getElementById('alarm-time').value = `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}:00`;
            setDir('L');
        };
    </script>
</body>
</html>
