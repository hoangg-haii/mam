<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Điều khiển Dải phân cách ESP32</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Chống bôi đen toàn bộ ứng dụng */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .control-btn { 
            transition: all 0.1s; 
            user-select: none; 
            -webkit-user-select: none;
            touch-action: none; 
        }
        
        .control-btn:active { transform: scale(0.92); filter: brightness(0.7); }
        .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
        .btn-pressed { background-color: #1e293b !important; color: white !important; border-color: #1e293b !important; }
        .direction-selected { background-color: #4f46e5 !important; color: white !important; border-color: #4338ca !important; }
        
        /* Đảm bảo các input vẫn có thể chọn được */
        input {
            -webkit-user-select: text;
            user-select: text;
        }

        * { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4 font-sans text-slate-800">

    <div class="bg-white p-6 rounded-[2.5rem] shadow-2xl w-full max-w-md border border-gray-200">
        <h1 class="text-2xl font-black text-center text-slate-800 mb-1 uppercase tracking-tight">Trình điều khiển</h1>
        <p class="text-[10px] text-center text-gray-400 mb-6 font-bold tracking-widest uppercase">Hệ thống dải phân cách tự động</p>

        <!-- Trạng thái kết nối -->
        <div class="flex items-center justify-between bg-slate-50 p-4 rounded-2xl mb-6 shadow-inner border border-slate-100">
            <div class="flex items-center">
                <div id="status-indicator" class="status-dot bg-red-500 mr-3 animate-pulse"></div>
                <span id="status-text" class="text-xs font-black uppercase tracking-wider text-slate-500">Chưa kết nối</span>
            </div>
            <button id="connect-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-xl font-bold text-sm shadow-lg transition-all active:scale-95">
                KẾT NỐI
            </button>
        </div>

        <!-- RTC Display -->
        <div class="text-center mb-6 bg-slate-900 p-6 rounded-[2rem] shadow-xl border-b-4 border-slate-950">
            <p class="text-[10px] text-slate-500 uppercase font-black mb-2 tracking-widest">Thời gian điện thoại</p>
            <div id="rtc-display" class="text-5xl font-mono font-bold text-green-400 tracking-tighter drop-shadow-[0_0_8px_rgba(74,222,128,0.5)]">--:--:--</div>
        </div>

        <!-- Bảng điều khiển -->
        <div class="grid grid-cols-3 gap-5 mb-8">
            <!-- Row 1 -->
            <button data-cmd="1" class="momentary-btn bg-white border-2 border-slate-100 p-6 rounded-3xl font-black text-2xl text-slate-700 shadow-sm active:border-slate-800">L1</button>
            <button data-cmd="t" class="momentary-btn bg-slate-100 text-slate-700 p-8 rounded-3xl flex justify-center shadow-md border-b-4 border-slate-300 active:border-b-0 active:translate-y-1">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><path d="m18 15-6-6-6 6"/></svg>
            </button>
            <button data-cmd="3" class="momentary-btn bg-white border-2 border-slate-100 p-6 rounded-3xl font-black text-2xl text-slate-700 shadow-sm active:border-slate-800">R1</button>

            <!-- Row 2 -->
            <button data-cmd="2" class="momentary-btn bg-white border-2 border-slate-100 p-6 rounded-3xl font-black text-2xl text-slate-700 shadow-sm active:border-slate-800">L2</button>
            <button data-cmd="l" class="momentary-btn bg-slate-100 text-slate-700 p-8 rounded-3xl flex justify-center shadow-md border-b-4 border-slate-300 active:border-b-0 active:translate-y-1">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><path d="m6 9 6 6 6-6"/></svg>
            </button>
            <button data-cmd="4" class="momentary-btn bg-white border-2 border-slate-100 p-6 rounded-3xl font-black text-2xl text-slate-700 shadow-sm active:border-slate-800">R2</button>
        </div>

        <!-- Hẹn giờ -->
        <div class="bg-indigo-50 p-6 rounded-[2rem] border border-indigo-100 shadow-sm">
            <h2 class="text-[10px] font-black mb-4 text-indigo-800 uppercase tracking-[0.2em] text-center">Đặt lịch mở dải phân cách</h2>
            <div class="flex flex-col gap-3">
                <input type="time" id="alarm-time" step="1" class="w-full border-2 border-indigo-100 rounded-2xl p-4 text-2xl font-bold text-indigo-900 bg-white focus:outline-none focus:border-indigo-500 text-center">
                
                <!-- Lựa chọn hướng -->
                <div class="flex gap-2">
                    <button id="dir-left" onclick="selectDirection('L')" class="flex-1 bg-white border-2 border-indigo-100 py-3 rounded-xl font-bold text-indigo-700 transition-all">
                        SANG TRÁI
                    </button>
                    <button id="dir-right" onclick="selectDirection('R')" class="flex-1 bg-white border-2 border-indigo-100 py-3 rounded-xl font-bold text-indigo-700 transition-all">
                        SANG PHẢI
                    </button>
                </div>

                <button onclick="setAlarm()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black text-lg shadow-lg hover:bg-indigo-700 active:scale-[0.98] transition-all">
                    XÁC NHẬN HẸN GIỜ
                </button>
            </div>
            <p id="alarm-status" class="text-[10px] text-indigo-500 mt-3 font-bold italic text-center min-h-[1.2em] uppercase"></p>
        </div>

        <p class="text-[9px] text-slate-300 mt-6 text-center uppercase tracking-widest font-bold">BTLE v3.8 • Anti-Selection Update</p>
    </div>

    <script>
        const SERVICE_UUID = "0000ffe0-0000-1000-8000-00805f9b34fb";
        const CHARACTERISTIC_UUID = "0000ffe1-0000-1000-8000-00805f9b34fb";
        
        let device, characteristic;
        let isSending = false;
        let sendQueue = [];
        let syncTimer = null;
        let uiClockTimer = null;
        let selectedDir = 'L';

        // Chặn menu ngữ cảnh trên toàn bộ trang (đặc biệt là các nút)
        window.oncontextmenu = function(event) {
            event.preventDefault();
            event.stopPropagation();
            return false;
        };

        const buttons = document.querySelectorAll('.momentary-btn');
        document.getElementById('dir-left').classList.add('direction-selected');

        function selectDirection(dir) {
            selectedDir = dir;
            const leftBtn = document.getElementById('dir-left');
            const rightBtn = document.getElementById('dir-right');
            if (dir === 'L') {
                leftBtn.classList.add('direction-selected');
                rightBtn.classList.remove('direction-selected');
            } else {
                rightBtn.classList.add('direction-selected');
                leftBtn.classList.remove('direction-selected');
            }
        }

        function updateUIClock() {
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ":" + 
                            now.getMinutes().toString().padStart(2, '0') + ":" + 
                            now.getSeconds().toString().padStart(2, '0');
            document.getElementById('rtc-display').innerText = timeStr;
        }
        uiClockTimer = setInterval(updateUIClock, 1000);

        buttons.forEach(btn => {
            const startAction = (e) => {
                if (e.cancelable) e.preventDefault();
                if (btn.classList.contains('btn-pressed')) return;
                const cmd = btn.getAttribute('data-cmd');
                btn.classList.add('btn-pressed');
                sendCmd(cmd);
            };

            const stopAction = (e) => {
                if (e.cancelable) e.preventDefault();
                if (btn.classList.contains('btn-pressed')) {
                    btn.classList.remove('btn-pressed');
                    sendCmd('d'); 
                }
            };

            // Gắn sự kiện chặn mặc định để tránh bôi đen/zoom
            btn.addEventListener('touchstart', startAction, {passive: false});
            btn.addEventListener('touchend', stopAction, {passive: false});
            btn.addEventListener('touchcancel', stopAction, {passive: false});
            btn.addEventListener('mousedown', startAction);
            btn.addEventListener('mouseup', stopAction);
            btn.addEventListener('mouseleave', stopAction);
        });

        document.getElementById('connect-btn').addEventListener('click', async () => {
            if (device && device.gatt.connected) {
                await device.gatt.disconnect();
                return;
            }
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ESP32_Motor_Control' }],
                    optionalServices: [SERVICE_UUID]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                await characteristic.startNotifications();
                device.addEventListener('gattserverdisconnected', onDisconnected);
                updateUI(true);
                startBackgroundSync();
            } catch (err) {
                console.error("Lỗi:", err);
                updateUI(false);
            }
        });

        function onDisconnected() {
            updateUI(false);
            characteristic = null;
            device = null;
            stopBackgroundSync();
        }

        function syncTimeNow() {
            if (!characteristic || !device || !device.gatt.connected) return;
            const now = new Date();
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');
            sendCmd(`S${hh}${mm}${ss}`, true); 
        }

        function startBackgroundSync() {
            stopBackgroundSync();
            syncTimeNow();
            syncTimer = setInterval(syncTimeNow, 30000);
        }

        function stopBackgroundSync() {
            if (syncTimer) { clearInterval(syncTimer); syncTimer = null; }
        }

        function updateUI(connected) {
            const st = document.getElementById('status-text');
            const si = document.getElementById('status-indicator');
            const cb = document.getElementById('connect-btn');
            st.innerText = connected ? "Đã kết nối" : "Chưa kết nối";
            si.className = connected ? "status-dot bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]" : "status-dot bg-red-500 animate-pulse";
            cb.innerText = connected ? "NGẮT" : "KẾT NỐI";
            cb.className = connected 
                ? "bg-slate-100 text-slate-600 border border-slate-200 px-5 py-2 rounded-xl font-bold text-sm" 
                : "bg-blue-600 text-white px-5 py-2 rounded-xl font-bold text-sm shadow-lg";
        }

        async function sendCmd(cmd, isPriority = false) {
            if (!characteristic) return;
            if (isSending && !isPriority) {
                sendQueue = [cmd]; 
                return;
            }
            try {
                isSending = true;
                const data = new TextEncoder().encode(cmd + "\n");
                try {
                    await characteristic.writeValueWithoutResponse(data);
                } catch (e) {
                    await characteristic.writeValue(data);
                }
            } catch (err) {
                if (!device || !device.gatt.connected) onDisconnected();
            } finally {
                setTimeout(() => {
                    isSending = false;
                    if (sendQueue.length > 0) sendCmd(sendQueue.shift());
                }, 60); 
            }
        }

        function setAlarm() {
            const timeVal = document.getElementById('alarm-time').value;
            if (!timeVal) return;
            const parts = timeVal.split(':');
            let hh = parts[0].padStart(2, '0');
            let mm = parts[1].padStart(2, '0');
            let ss = (parts[2] || "00").padStart(2, '0');
            sendCmd(hh + mm + ss + selectedDir); 
            const statusEl = document.getElementById('alarm-status');
            const dirText = selectedDir === 'L' ? "SANG TRÁI" : "SANG PHẢI";
            statusEl.innerText = `ĐÃ GỬI: ${hh}:${mm}:${ss} (${dirText})`;
            setTimeout(() => { statusEl.innerText = ""; }, 4000);
        }
    </script>
</body>
</html>
