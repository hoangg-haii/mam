<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hệ thống dải phân cách v4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains_Mono:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --dark-bg: #0f172a; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
            position: fixed;
            width: 100%; height: 100%;
            touch-action: none;
        }

        body.dark-theme { background-color: #020617; color: #f8fafc; }
        .dark-theme .bg-white { background-color: #1e293b; border-color: #334155; color: white; }
        .dark-theme .bg-slate-50 { background-color: #0f172a; }
        .dark-theme .border { border-color: #334155; }

        .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(22px); }

        .segmented-control { display: flex; background-color: #f1f5f9; padding: 4px; border-radius: 12px; }
        .dark-theme .segmented-control { background-color: #020617; }
        .segmented-item {
            flex: 1; padding: 10px; font-size: 10px; font-weight: 800; text-align: center;
            border-radius: 8px; cursor: pointer; transition: all 0.2s; text-transform: uppercase;
        }
        .segmented-item.active { background-color: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .dark-theme .segmented-item.active { background-color: #1e293b; color: #818cf8; }

        .btn-pressed { background-color: #000 !important; color: white !important; transform: scale(0.95); }
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="flex flex-col items-center">

    <!-- LỚP PHỦ KẾT NỐI -->
    <div id="intro-popup" class="fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center p-6 text-center">
        <div class="max-w-xs w-full space-y-6">
            <img src="https://storage-vnportal.vnpt.vn/qnm-ubnd/5892/TuanTQC/Tuan20t11/logo.png" class="w-24 h-24 mx-auto drop-shadow-2xl">
            <div class="space-y-4">
                <h1 class="text-white font-black text-xl leading-tight uppercase">Dải Phân Cách Thông Minh</h1>
                <p class="text-emerald-400 font-bold text-[10px] tracking-[0.2em] uppercase">Phiên bản v4.0.0</p>
            </div>
            <button id="connect-btn" onclick="handleBluetoothConnection()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl active:scale-95 flex items-center justify-center gap-3">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 7l14 10-9 4V3l9 4-14 10"/></svg>
                Kết nối Bluetooth
            </button>
            <p id="intro-status" class="text-slate-500 text-[10px] font-bold uppercase italic">Vui lòng kết nối để đồng bộ hệ thống</p>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div id="overlay" class="fixed inset-0 z-[60] bg-slate-900/50 hidden opacity-0 transition-opacity duration-300" onclick="toggleSidebar()"></div>
    <div id="sidebar" class="fixed top-0 left-0 bottom-0 w-72 bg-white z-[70] shadow-2xl translate-x-[-100%] flex flex-col">
        <div class="p-8 bg-slate-900 text-white flex flex-col items-center">
            <img src="https://storage-vnportal.vnpt.vn/qnm-ubnd/5892/TuanTQC/Tuan20t11/logo.png" class="w-16 h-16 mb-4">
            <h2 class="text-[10px] font-black uppercase tracking-widest">Hệ thống v4.0</h2>
        </div>
        <nav class="flex-1 p-5 space-y-2 overflow-y-auto">
            <button onclick="showPage('control')" class="w-full p-4 rounded-xl hover:bg-slate-50 text-slate-700 font-black text-[11px] uppercase text-left flex items-center gap-3">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                Điều khiển thiết bị
            </button>
            <button onclick="showPage('alarm')" class="w-full p-4 rounded-xl hover:bg-slate-50 text-slate-700 font-black text-[11px] uppercase text-left flex items-center gap-3">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                Cảnh báo khẩn cấp
            </button>
            <div class="h-[1px] bg-slate-100 my-2"></div>
            <button id="menu-day-night-btn" onclick="toggleDayNightMode()" class="w-full p-4 rounded-xl bg-amber-50 text-amber-600 font-black text-[11px] uppercase text-left flex items-center justify-between">
                <span class="flex items-center gap-3">
                    <span id="menu-dn-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="23"/><line x1="1" y1="12" x2="23" y2="12"/></svg></span>
                    Chế độ: <span id="menu-dn-text">Ngày (Sáng)</span>
                </span>
            </button>
            <button onclick="showPage('settings')" class="w-full p-4 rounded-xl hover:bg-slate-50 text-slate-700 font-black text-[11px] uppercase text-left flex items-center gap-3">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1-2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                Giao diện & Chủ đề
            </button>
        </nav>
        <div class="p-5 border-t">
            <button onclick="manualDisconnect()" class="w-full p-4 rounded-xl bg-rose-50 text-rose-600 font-black text-[10px] uppercase">Ngắt kết nối</button>
        </div>
    </div>

    <!-- HEADER -->
    <header class="w-full pt-8 px-6 space-y-4 z-50">
        <div class="flex items-center justify-between">
            <button onclick="toggleSidebar()" class="p-3 bg-white shadow-sm rounded-xl border">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            </button>
            <div id="conn-indicator" class="text-[10px] font-black uppercase text-rose-500 flex items-center gap-1">
                <span class="w-1.5 h-1.5 rounded-full bg-current animate-pulse"></span> Offline
            </div>
            <div class="w-10"></div>
        </div>

        <div id="mode-container" class="w-full bg-white p-1.5 rounded-2xl border shadow-sm max-w-xs mx-auto">
            <div class="segmented-control">
                <div id="mode-auto" class="segmented-item active" onclick="setGlobalMode('auto')">Tự động</div>
                <div id="mode-manual" class="segmented-item" onclick="setGlobalMode('manual')">Thủ công</div>
            </div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="w-full max-w-md px-6 flex-1 py-4 overflow-hidden">
        
        <!-- TRANG ĐIỀU KHIỂN -->
        <div id="page-control" class="h-full flex flex-col space-y-3">
            <div class="bg-slate-900 p-5 rounded-[2rem] text-center shadow-xl border-b-4 border-indigo-600">
                <div class="rtc-display text-4xl font-['JetBrains_Mono'] font-bold text-emerald-400">00:00:00</div>
                <div id="sync-status" class="text-[9px] font-black text-emerald-600/60 uppercase mt-2 tracking-widest italic">CHỜ ĐỒNG BỘ...</div>
            </div>

            <div id="auto-interface" class="flex-1 flex flex-col space-y-3 overflow-hidden">
                <div class="bg-white p-4 rounded-[1.5rem] border space-y-3">
                    <input type="time" id="alarm-time" step="1" value="07:00:00" class="w-full text-3xl font-['JetBrains_Mono'] font-black bg-slate-50 rounded-xl py-3 text-center border">
                    <div class="flex gap-2">
                        <button id="dir-L" onclick="setDir('L')" class="flex-1 py-3 rounded-xl font-black text-[10px] uppercase bg-indigo-600 text-white shadow-md">Trái (L)</button>
                        <button id="dir-R" onclick="setDir('R')" class="flex-1 py-3 rounded-xl font-black text-[10px] uppercase bg-slate-100 text-slate-400">Phải (R)</button>
                    </div>
                    <button onclick="addAlarm()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-black uppercase text-[10px] shadow-lg active:scale-95">Lưu lịch trình</button>
                </div>
                
                <div id="pending-list" class="flex-1 overflow-y-auto space-y-2"></div>
                
                <!-- NÚT DỪNG KHẨN CẤP GIAO DIỆN TỰ ĐỘNG -->
                <button onclick="send('dkc', true)" class="w-full bg-rose-600 text-white py-4 rounded-xl font-black text-[10px] uppercase shadow-xl active:bg-rose-700">
                    <div class="flex items-center justify-center gap-2">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
                        Dừng khẩn cấp (Auto)
                    </div>
                </button>
            </div>

            <div id="manual-interface" class="hidden flex-1 grid grid-cols-3 gap-3 items-center content-center">
                <button data-cmd="1" class="momentary-btn h-16 bg-white border-2 rounded-2xl font-black text-xl">L1</button>
                <button data-cmd="t" class="momentary-btn h-16 bg-slate-900 text-white rounded-2xl"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" class="mx-auto"><path d="m18 15-6-6-6 6"/></svg></button>
                <button data-cmd="3" class="momentary-btn h-16 bg-white border-2 rounded-2xl font-black text-xl">R1</button>
                <button data-cmd="2" class="momentary-btn h-16 bg-white border-2 rounded-2xl font-black text-xl">L2</button>
                <button data-cmd="l" class="momentary-btn h-16 bg-slate-900 text-white rounded-2xl"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" class="mx-auto"><path d="m6 9 6 6 6-6"/></svg></button>
                <button data-cmd="4" class="momentary-btn h-16 bg-white border-2 rounded-2xl font-black text-xl">R2</button>
                <div class="col-span-3">
                    <button onclick="send('dkc', true)" class="w-full bg-rose-600 text-white py-6 rounded-2xl font-black text-xs uppercase shadow-lg">Dừng khẩn cấp (Manual)</button>
                </div>
            </div>
        </div>

        <!-- TRANG CẢNH BÁO -->
        <div id="page-alarm" class="hidden h-full flex flex-col space-y-4">
            <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center mt-4">Trạng thái cảnh báo</h2>
            <div class="bg-white p-5 rounded-[1.5rem] border space-y-4 shadow-sm">
                <div class="flex items-center justify-between p-4 bg-slate-50 border rounded-xl">
                    <span class="text-[10px] font-bold text-slate-700 uppercase">Còi báo (Buzzer)</span>
                    <label class="switch"><input type="checkbox" id="buzzer-toggle" onchange="send(this.checked ? 'ccbn' : 'ccbf', true)"><span class="slider"></span></label>
                </div>
                <div class="flex items-center justify-between p-4 bg-slate-50 border rounded-xl">
                    <span class="text-[10px] font-bold text-slate-700 uppercase">Đèn cảnh báo (Led)</span>
                    <label class="switch"><input type="checkbox" id="light-toggle" onchange="send(this.checked ? 'cbon' : 'cbof', true)"><span class="slider"></span></label>
                </div>
            </div>
            <div class="mt-auto space-y-3 mb-6">
                <button onclick="toggleAllAlerts(true)" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black uppercase text-xs">Bật tất cả cảnh báo</button>
                <button onclick="toggleAllAlerts(false)" class="w-full bg-white border-2 text-slate-400 py-5 rounded-2xl font-black uppercase text-xs">Tắt toàn bộ</button>
            </div>
        </div>

        <!-- TRANG CÀI ĐẶT -->
        <div id="page-settings" class="hidden h-full flex flex-col space-y-4">
            <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center mt-4">Cấu hình</h2>
            <div class="bg-white p-5 rounded-[1.5rem] border space-y-4 shadow-sm">
                <button onclick="toggleTheme()" class="w-full flex items-center justify-between p-4 bg-slate-50 border rounded-xl active:scale-95">
                    <span class="text-[10px] font-bold text-slate-700 uppercase">Chế độ giao diện</span>
                    <span id="theme-label" class="text-[10px] font-black text-indigo-600 uppercase">Sáng</span>
                </button>
            </div>
        </div>
    </main>

    <footer class="fixed bottom-0 w-full p-4 bg-white/80 backdrop-blur-md border-t z-40 text-center">
        <div id="console-log" class="font-mono text-[9px] text-slate-400 uppercase font-bold tracking-tighter italic leading-none">V4.0 Sẵn sàng...</div>
        <div id="last-sync" class="text-[7px] text-emerald-500 font-black uppercase mt-1">Đồng bộ: Chưa thực hiện</div>
    </footer>

    <script>
        const UUID_SER = "0000ffe0-0000-1000-8000-00805f9b34fb";
        const UUID_CHA = "0000ffe1-0000-1000-8000-00805f9b34fb";
        let device, char, isBusy = false, dir = 'L', currentMode = 'auto', isNight = false, isDarkTheme = false;
        let alarms = [];
        let syncInterval = null;

        function log(msg) { document.getElementById('console-log').innerText = `> ${msg}`; }

        async function handleBluetoothConnection() {
            try {
                const statusEl = document.getElementById('intro-status');
                statusEl.innerText = "ĐANG TÌM KIẾM...";
                
                device = await navigator.bluetooth.requestDevice({ 
                    filters: [{ name: 'ESP32_Motor_Control' }], 
                    optionalServices: [UUID_SER] 
                });
                
                device.addEventListener('gattserverdisconnected', () => { 
                    document.getElementById('intro-popup').style.display = 'flex'; 
                    updateConnUI(false); 
                    if (syncInterval) clearInterval(syncInterval);
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(UUID_SER);
                char = await service.getCharacteristic(UUID_CHA);
                await char.startNotifications();
                
                updateConnUI(true);
                log("CONNECTED - SYNCING...");
                
                document.getElementById('intro-popup').style.display = 'none';
                
                // Đồng bộ lần đầu sau 1.5s
                setTimeout(() => {
                    syncPhoneTime();
                    send('on', true);
                    // Thiết lập đồng bộ mỗi 2 phút (120,000ms)
                    if (syncInterval) clearInterval(syncInterval);
                    syncInterval = setInterval(syncPhoneTime, 120000);
                }, 1500);

            } catch (err) { 
                document.getElementById('intro-status').innerText = "KẾT NỐI THẤT BẠI!"; 
            }
        }

        function updateConnUI(isConnected) {
            const ind = document.getElementById('conn-indicator');
            ind.className = isConnected 
                ? "text-[10px] font-black uppercase text-emerald-500 flex items-center gap-1" 
                : "text-[10px] font-black uppercase text-rose-500 flex items-center gap-1";
            ind.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-current ${isConnected?'':'animate-pulse'}"></span> ${isConnected?'Online':'Offline'}`;
        }

        async function send(c, force = false) {
            if (!char || (!force && isBusy)) return;
            if (!force) isBusy = true;
            try {
                await char.writeValue(new TextEncoder().encode(c + "\n"));
                log(`SEND: ${c}`);
            } catch (e) { log("ERR: SEND FAIL"); }
            if (!force) setTimeout(() => isBusy = false, 120);
        }

        function syncPhoneTime() {
            const n = new Date();
            const h = String(n.getHours()).padStart(2,'0'), 
                  m = String(n.getMinutes()).padStart(2,'0'), 
                  s = String(n.getSeconds()).padStart(2,'0');
            
            // Định dạng STHHMMSS theo yêu cầu
            const cmd = `ST${h}${m}${s}`;
            send(cmd, true);
            
            document.getElementById('sync-status').innerText = n.toLocaleDateString('vi-VN');
            document.getElementById('last-sync').innerText = `Đồng bộ: ${h}:${m}:${s}`;
            log(`AUTO SYNC: ${h}:${m}:${s}`);
        }

        function toggleDayNightMode() {
            isNight = !isNight;
            const btn = document.getElementById('menu-day-night-btn');
            const txt = document.getElementById('menu-dn-text');
            const icon = document.getElementById('menu-dn-icon');

            if (isNight) {
                btn.className = "w-full p-4 rounded-xl bg-indigo-50 text-indigo-600 font-black text-[11px] uppercase text-left flex items-center justify-between";
                txt.innerText = "Đêm (Tối)";
                icon.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`;
                send('dem', true);
            } else {
                btn.className = "w-full p-4 rounded-xl bg-amber-50 text-amber-600 font-black text-[11px] uppercase text-left flex items-center justify-between";
                txt.innerText = "Ngày (Sáng)";
                icon.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="1" y1="12" x2="23" y2="12"/></svg>`;
                send('ngay', true);
            }
        }

        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            document.body.classList.toggle('dark-theme', isDarkTheme);
            document.getElementById('theme-label').innerText = isDarkTheme ? "Tối" : "Sáng";
        }

        function toggleAllAlerts(state) {
            document.getElementById('buzzer-toggle').checked = state;
            document.getElementById('light-toggle').checked = state;
            send(state ? 'ccbn' : 'ccbf', true);
            setTimeout(() => send(state ? 'cbon' : 'cbof', true), 250);
        }

        function showPage(p) {
            document.getElementById('page-control').classList.toggle('hidden', p !== 'control');
            document.getElementById('page-alarm').classList.toggle('hidden', p !== 'alarm');
            document.getElementById('page-settings').classList.toggle('hidden', p !== 'settings');
            document.getElementById('mode-container').classList.toggle('hidden', p !== 'control');
            toggleSidebar();
        }

        function toggleSidebar() {
            const s = document.getElementById('sidebar'), o = document.getElementById('overlay');
            const isOpen = !s.classList.contains('translate-x-[-100%]');
            s.classList.toggle('translate-x-[-100%]', isOpen);
            o.classList.toggle('hidden', isOpen);
            if (!isOpen) setTimeout(() => o.style.opacity = '1', 10);
            else o.style.opacity = '0';
        }

        function setGlobalMode(mode) {
            currentMode = mode;
            document.getElementById('mode-auto').classList.toggle('active', mode === 'auto');
            document.getElementById('mode-manual').classList.toggle('active', mode === 'manual');
            document.getElementById('auto-interface').classList.toggle('hidden', mode === 'manual');
            document.getElementById('manual-interface').classList.toggle('hidden', mode === 'auto');
            send(mode === 'manual' ? 'n' : 'h', true);
        }

        function setDir(d) {
            dir = d;
            document.getElementById('dir-L').className = `flex-1 py-3 rounded-xl font-black text-[10px] uppercase ${d === 'L' ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-400'}`;
            document.getElementById('dir-R').className = `flex-1 py-3 rounded-xl font-black text-[10px] uppercase ${d === 'R' ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-400'}`;
        }

        function addAlarm() {
            const t = document.getElementById('alarm-time').value; 
            if (!t) return;
            const hms = t.replace(/:/g, '');
            send(hms + dir, true);
            alarms.push({ id: Date.now(), time: t, raw: hms, dir: dir });
            renderAlarms();
        }

        function renderAlarms() {
            const list = document.getElementById('pending-list');
            list.innerHTML = alarms.length === 0 ? '<div class="text-center py-10 opacity-20 italic text-[10px] font-black uppercase">Chưa có lịch trình</div>' : '';
            alarms.sort((a,b) => a.time.localeCompare(b.time)).forEach(item => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-3 bg-white rounded-xl border mb-2 shadow-sm";
                div.innerHTML = `<div><p class="font-['JetBrains_Mono'] font-bold text-base leading-none">${item.time}</p><p class="text-[7px] uppercase text-slate-400 font-black mt-1">Hướng: ${item.dir}</p></div>
                                 <button onclick="removeAlarm(${item.id})" class="text-rose-500 p-2"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>`;
                list.appendChild(div);
            });
        }

        function removeAlarm(id) {
            const item = alarms.find(a => a.id === id);
            if (item) send(`X${item.raw}`, true);
            alarms = alarms.filter(a => a.id !== id);
            renderAlarms();
        }

        function manualDisconnect() {
            if (device && device.gatt.connected) device.gatt.disconnect();
            location.reload();
        }

        setInterval(() => {
            const n = new Date();
            document.querySelectorAll('.rtc-display').forEach(el => el.innerText = n.toLocaleTimeString('en-GB'));
        }, 1000);

        document.querySelectorAll('.momentary-btn').forEach(btn => {
            const start = (e) => { if (currentMode==='manual') { e.preventDefault(); btn.classList.add('btn-pressed'); send(btn.dataset.cmd, true); } };
            const end = () => { if (currentMode==='manual') { btn.classList.remove('btn-pressed'); send('d', true); } };
            btn.onmousedown = btn.ontouchstart = start;
            btn.onmouseup = btn.ontouchend = btn.onmouseleave = end;
        });
    </script>
</body>
</html>
